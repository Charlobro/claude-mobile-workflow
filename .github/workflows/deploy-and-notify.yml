name: Deploy and Notify

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm install
        fi
        
    - name: Build project
      run: |
        if [ -f package.json ] && npm run build --if-present; then
          echo "Build successful"
        else
          echo "No build script or build not needed"
        fi
        
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: .
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
        
    - name: Send Discord notification
      if: false
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK }}
        title: "🚀 Déploiement terminé - Temps de tester !"
        description: |
          **Commit:** ${{ github.event.head_commit.message }}
          **Status:** ${{ job.status }}
          **URL de test:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          
          📱 **Action requise:** Testez sur votre mobile et laissez un feedback dans les issues !
        color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}
        
    - name: Send email notification
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "🧪 Test requis - Projet ${{ github.event.repository.name }}"
        body: |
          Bonjour !
          
          Claude a terminé une étape de développement et a besoin de votre feedback.
          
          📋 **Détails:**
          - Commit: ${{ github.event.head_commit.message }}
          - Status: ${{ job.status }}
          
          🔗 **Testez ici:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          
          💬 **Laissez votre feedback ici:** https://github.com/${{ github.repository }}/issues
          
          ▶️ Cliquez "New issue" puis choisissez le template "📱 Feedback de test mobile"
          
          Claude reprendra le travail dès que vous lui donnerez le feedback !
        to: ${{ secrets.EMAIL_TO }}
        from: Claude Code Workflow <${{ secrets.EMAIL_USERNAME }}>