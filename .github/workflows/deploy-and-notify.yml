name: Deploy and Notify

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm install
        fi
        
    - name: Build project
      run: |
        if [ -f package.json ] && npm run build --if-present; then
          echo "Build successful"
        else
          echo "No build script or build not needed"
        fi
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        
    - name: Send Discord notification
      if: always()
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK }}
        title: "ðŸš€ DÃ©ploiement terminÃ© - Temps de tester !"
        description: |
          **Commit:** ${{ github.event.head_commit.message }}
          **Status:** ${{ job.status }}
          **URL de test:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          
          ðŸ“± **Action requise:** Testez sur votre mobile et laissez un feedback dans les issues !
        color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}
        
    - name: Send email notification
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ðŸ§ª Test requis - Projet ${{ github.event.repository.name }}"
        body: |
          Bonjour !
          
          Claude a terminÃ© une Ã©tape de dÃ©veloppement et a besoin de votre feedback.
          
          ðŸ“‹ **DÃ©tails:**
          - Commit: ${{ github.event.head_commit.message }}
          - Status: ${{ job.status }}
          
          ðŸ”— **Testez ici:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          
          ðŸ’¬ **Feedback:** CrÃ©ez une issue sur GitHub avec vos commentaires
          
          Claude reprendra le travail dÃ¨s que vous lui donnerez le feedback !
        to: ${{ secrets.EMAIL_TO }}
        from: Claude Code Workflow <${{ secrets.EMAIL_USERNAME }}>